&НаКлиенте
Процедура СделатьФото(Команда)
	
	#Если МобильноеПриложениеКлиент Тогда
		
		Попытка
			Если СредстваМультимедиа.ПоддерживаетсяФотоснимок() Тогда
				
				ДанныеМультимедиа = СредстваМультимедиа.СделатьФотоснимок();
				
				Если ДанныеМультимедиа <> Неопределено Тогда
					
					ДвоичныеДанныеФото = ДанныеМультимедиа.ПолучитьДвоичныеДанные();
					Адрес = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФото, ЭтаФорма.УникальныйИдентификатор);
					
					СсылкаНаКартинку = Адрес;
					Модифицированность = Истина;
					
				КонецЕсли;
				
			Иначе
				Сообщить("Камера не поддерживается");
			КонецЕсли;
			
		Исключение
			Сообщить("Ошибка: " + ОписаниеОшибки());
		КонецПопытки;
		
	#КонецЕсли
	
КонецПроцедуры

&НаКлиенте
Процедура ВыбратьИзГалереи(Команда)
	
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.Фильтр = "Изображения (*.jpg, *.jpeg, *.png)|*.jpg;*.jpeg;*.png";
	Диалог.МножественныйВыбор = Ложь;
	
	Если Диалог.Выбрать() Тогда
		
		Попытка
			Файл = Новый ДвоичныеДанные(Диалог.ПолноеИмяФайла);
			Адрес = ПоместитьВоВременноеХранилище(Файл, ЭтаФорма.УникальныйИдентификатор);
			
			СсылкаНаКартинку = Адрес;
			Модифицированность = Истина;
			
		Исключение
			Сообщить("Ошибка: " + ОписаниеОшибки());
		КонецПопытки;
		
	КонецЕсли;
	
КонецПроцедуры


&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	Если ЭтоАдресВременногоХранилища(СсылкаНаКартинку) Тогда
		
		ДанныеКартинки = ПолучитьИзВременногоХранилища(СсылкаНаКартинку);
		
		// Кодируем в Base64 и сохраняем в реквизит документа
		ТекущийОбъект.СсылкаНаКартинку = Base64Строка(ДанныеКартинки);
		
		УдалитьИзВременногоХранилища(СсылкаНаКартинку);
		
	ИначеЕсли СсылкаНаКартинку = "" Тогда
		ТекущийОбъект.СсылкаНаКартинку = "";
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Не Объект.Ссылка.Пустая() И ЗначениеЗаполнено(Объект.СсылкаНаКартинку) Тогда
		
		// Декодируем из Base64 во временное хранилище для отображения
		ДвоичныеДанные = Base64Значение(Объект.СсылкаНаКартинку);
		СсылкаНаКартинку = ПоместитьВоВременноеХранилище(ДвоичныеДанные, ЭтаФорма.УникальныйИдентификатор);
		
	КонецЕсли;
	
КонецПроцедуры